<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test - Virginia</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #messages { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; margin: 20px 0; }
        .user { color: blue; margin: 5px 0; }
        .assistant { color: green; margin: 5px 0; }
        .system { color: gray; font-style: italic; margin: 5px 0; }
        button { padding: 10px 20px; margin: 5px; }
        input { width: 500px; padding: 10px; }
    </style>
</head>
<body>
    <h1>WebSocket í…ŒìŠ¤íŠ¸ - Virginia Region</h1>
    <div>
        <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." value="ì•ˆë…•í•˜ì„¸ìš”! ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì–´ë–¤ê°€ìš”?">
        <button onclick="sendMessage()">ì „ì†¡</button>
        <button onclick="testMemory()">ëŒ€í™” ê¸°ì–µ í…ŒìŠ¤íŠ¸</button>
    </div>
    <div id="messages"></div>

    <script>
        const wsUrl = 'wss://hsdpbajz23.execute-api.us-east-1.amazonaws.com/production';
        let ws = null;
        let conversationId = `test-${Date.now()}`;
        let conversationHistory = [];

        function connect() {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                log('âœ… WebSocket ì—°ê²° ì„±ê³µ (Virginia)', 'system');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Received:', data);
                
                if (data.type === 'ai_chunk') {
                    appendToLastAssistant(data.chunk);
                } else if (data.type === 'chat_end') {
                    log(`\nâœ… ì‘ë‹µ ì™„ë£Œ (${data.total_chunks} chunks)`, 'system');
                    if (data.conversationId) {
                        conversationId = data.conversationId;
                        log(`ğŸ“ Conversation ID: ${conversationId}`, 'system');
                    }
                }
            };
            
            ws.onerror = (error) => {
                log(`âŒ ì—ëŸ¬: ${error}`, 'system');
            };
            
            ws.onclose = () => {
                log('ğŸ”Œ ì—°ê²° ì¢…ë£Œ', 'system');
            };
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value;
            
            if (!message) return;
            
            log(`User: ${message}`, 'user');
            
            // ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
            conversationHistory.push({role: 'user', content: message});
            
            const payload = {
                action: 'sendMessage',
                message: message,
                engineType: 'T5',
                conversationId: conversationId,
                conversationHistory: conversationHistory.slice(-10) // ìµœê·¼ 10ê°œë§Œ
            };
            
            ws.send(JSON.stringify(payload));
            input.value = '';
            
            // AI ì‘ë‹µ ì¤€ë¹„
            log('AI: ', 'assistant');
        }
        
        function testMemory() {
            // ì²« ë²ˆì§¸ ë©”ì‹œì§€
            const msg1 = "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” í…ŒìŠ¤íŠ¸ ì‚¬ìš©ìì…ë‹ˆë‹¤.";
            log(`User: ${msg1}`, 'user');
            conversationHistory.push({role: 'user', content: msg1});
            
            ws.send(JSON.stringify({
                action: 'sendMessage',
                message: msg1,
                engineType: 'T5',
                conversationId: conversationId,
                conversationHistory: []
            }));
            
            // AI ì‘ë‹µ ì¤€ë¹„
            log('AI: ', 'assistant');
            
            // 3ì´ˆ í›„ ë‘ ë²ˆì§¸ ë©”ì‹œì§€
            setTimeout(() => {
                const msg2 = "ì œê°€ ëˆ„êµ¬ë¼ê³  í–ˆì£ ?";
                log(`User: ${msg2}`, 'user');
                
                ws.send(JSON.stringify({
                    action: 'sendMessage',
                    message: msg2,
                    engineType: 'T5',
                    conversationId: conversationId,
                    conversationHistory: conversationHistory
                }));
                
                log('AI: ', 'assistant');
            }, 5000);
        }
        
        function log(message, className) {
            const messagesDiv = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = className;
            div.textContent = message;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function appendToLastAssistant(text) {
            const messagesDiv = document.getElementById('messages');
            const lastDiv = messagesDiv.lastElementChild;
            if (lastDiv && lastDiv.className === 'assistant') {
                lastDiv.textContent += text;
            }
        }
        
        // ìë™ ì—°ê²°
        connect();
    </script>
</body>
</html>